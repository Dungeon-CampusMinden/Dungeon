name: Java CI

on:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - name: Build with Gradle
        run: ./gradlew assemble

  check:
    name: Check files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: Check modified files
        id: check_files
        run: |
          git diff --name-only HEAD^ HEAD > files.txt
          echo "{changes}={false}" >> $GITHUB_OUTPUT
          while IFS= read -r file; do
            if [[ $file == */test/* ]]; then
              echo $file
              echo "{changes}={true}" >> $GITHUB_OUTPUT
              break
            fi
          done < files.txt

  junit_test_changed:
    name: JUnit if test changed
    needs: [build, check]
    if: $GITHUB_OUTPUT == true
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - name: JUnit
        run: ./gradlew test

  junit:
    name: JUnit if test not changed
    needs: [build, check]
    if: $GITHUB_OUTPUT == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - name: JUnit
        run: ./gradlew test

  checkstyle:
    name: Checkstyle
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - name: Checkstyle
        run: ./gradlew checkstyleMain

  spotless-java-format:
    name: Spotless
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - name: Spotless
        run: ./gradlew spotlessJavaCheck
