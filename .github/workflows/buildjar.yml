name: Build and Release Blockly JARs

on:
  push:
    branches:
      - '**'  
  workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            # 1. Node.js Setup f체r das Frontend
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: 'blockly/frontend/package-lock.json'

            # 2. Frontend bauen
            - name: Build Frontend
              run: |
                  cd blockly/frontend
                  npm install
                  npm run build

            # 3. Java Setup
            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'
                  cache: 'gradle'

            - name: Make gradlew executable
              run: chmod +x gradlew

            # 4. Beide JARs bauen (Desktop und Web)
            - name: Build JARs with Gradle
                # Wir rufen hier deine beiden neuen Tasks auf
              run: ./gradlew jarDesktop jarWeb

            # 5. Beide JAR-Artefakte f체r den n채chsten Job speichern
            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: Blockly-JARs
                  # Der Stern sorgt daf체r, dass alle Dateien im Ordner genommen werden
                  path: blockly/build/libs/*.jar

    deploy:
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Download the JARs
              uses: actions/download-artifact@v4
              with:
                  name: Blockly-JARs

            - name: Install GitHub CLI
              run: |
                sudo apt update
                sudo apt install -y gh

            - name: Create GitHub Release
              run: |
                TAG="v1.0.${{ github.run_number }}"

                gh release create "$TAG" *.jar \
                  --title "Release $TAG" \
                  --notes "Automatisch generiert von GitHub Actions" \
                  --draft=false \
                  --prerelease=false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
