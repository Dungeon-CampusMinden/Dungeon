name: Build and Release Blockly JARs

on:
    push:
        branches: [ "main", "master" ]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            # 1. Node.js Setup für das Frontend
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: 'blockly/frontend/package-lock.json'

            # 2. Frontend bauen
            - name: Build Frontend
              run: |
                  cd blockly/frontend
                  npm install
                  npm run build

            # 3. Java Setup
            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'
                  cache: 'gradle'

            - name: Make gradlew executable
              run: chmod +x gradlew

            # 4. Beide JARs bauen (Desktop und Web)
            - name: Build JARs with Gradle
                # Wir rufen hier deine beiden neuen Tasks auf
              run: ./gradlew jarDesktop jarWeb

            # 5. Beide JAR-Artefakte für den nächsten Job speichern
            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: Blockly-JARs
                  # Der Stern sorgt dafür, dass alle Dateien im Ordner genommen werden
                  path: blockly/build/libs/*.jar

    deploy:
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write
        # Nur auf dem master-branch ausführen
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

        steps:
            - name: Download the JARs
              uses: actions/download-artifact@v4
              with:
                  name: Blockly-JARs

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  # Hier laden wir jetzt alle JARs hoch, die wir gefunden haben
                  files: |
                      *.jar
                  tag_name: v1.0.${{ github.run_number }}
                  name: Release v1.0.${{ github.run_number }}
                  # draft: false macht es zu einem echten, öffentlichen Release!
                  draft: false
                  prerelease: false
                  generate_release_notes: true # GitHub schreibt automatisch, was sich geändert hat
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
